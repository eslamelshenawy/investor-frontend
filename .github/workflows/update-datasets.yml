name: Update Datasets

# ÙŠØ´ØªØºÙ„ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 6 ØµØ¨Ø§Ø­Ø§Ù‹ (ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© = 3 ØµØ¨Ø§Ø­Ø§Ù‹ UTC)
on:
  schedule:
    - cron: '0 3 * * *'  # ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 3 ØµØ¨Ø§Ø­Ø§Ù‹ UTC
  workflow_dispatch:  # Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # Ø³Ø§Ø¹ØªÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ (Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø³Ø±Ø¹ Ø¨ÙƒØ«ÙŠØ±)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Puppeteer browser
        run: npx puppeteer browsers install chrome

      - name: Sync ALL datasets (15,500+)
        run: |
          echo "ðŸš€ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ Datasets..."
          echo "â±ï¸ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 30-60 Ø¯Ù‚ÙŠÙ‚Ø©"
          echo ""
          node scripts/sync-all-datasets.cjs
          echo ""
          echo "âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©"
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true

      - name: Validate results
        id: validate
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
          if [ ! -f public/data/datasets.json ]; then
            echo "âŒ Ù…Ù„Ù datasets.json ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!"
            exit 1
          fi

          # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù€ datasets
          TOTAL=$(node -e "const d=require('./public/data/datasets.json'); console.log(d.total || d.datasets?.length || 0)")
          echo "ðŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù€ Datasets: $TOTAL"

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
          if [ "$TOTAL" -lt 1000 ]; then
            echo "âš ï¸ Ø¹Ø¯Ø¯ Ù‚Ù„ÙŠÙ„ Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ 10,000+"
            echo "VALID=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù‚Ø¨ÙˆÙ„"
            echo "VALID=true" >> $GITHUB_OUTPUT
          fi

          # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
          echo ""
          echo "ðŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ù„Ø¨:"
          node -e "const d=require('./public/data/datasets.json'); console.log(d.fetchedAt)"

          echo ""
          echo "ðŸ“ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù:"
          ls -lh public/data/datasets.json | awk '{print $5}'

          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
          if [ -f public/data/categories.json ]; then
            CATS=$(node -e "const c=require('./public/data/categories.json'); console.log(c.length)")
            echo ""
            echo "ðŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: $CATS"
          fi

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Commit and push
        if: steps.validate.outputs.VALID == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add public/data/

          if git diff --staged --quiet; then
            echo "ðŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª"
            exit 0
          fi

          # Ø¥Ù†Ø´Ø§Ø¡ commit Ø¬Ø¯ÙŠØ¯
          TOTAL=$(node -e "const d=require('./public/data/datasets.json'); console.log(d.total || 0)")
          DATE=$(date +'%Y-%m-%d %H:%M')

          git commit -m "ðŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: $TOTAL dataset [$DATE]"
          git push

          echo ""
          echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ðŸ”— Ø³ÙŠØªÙ… Ù†Ø´Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ù‰ Vercel ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹"

      - name: Summary
        run: |
          echo "## ðŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ø¯ÙŠØ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f public/data/datasets.json ]; then
            TOTAL=$(node -e "const d=require('./public/data/datasets.json'); console.log(d.total || 0)")
            DATE=$(node -e "const d=require('./public/data/datasets.json'); console.log(d.fetchedAt || 'N/A')")
            echo "- **Ø§Ù„Ù€ Datasets**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Ø§Ù„ØªØ§Ø±ÙŠØ®**: $DATE" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f public/data/categories.json ]; then
            CATS=$(node -e "const c=require('./public/data/categories.json'); console.log(c.length)")
            echo "- **Ø§Ù„Ø£Ù‚Ø³Ø§Ù…**: $CATS" >> $GITHUB_STEP_SUMMARY
          fi
